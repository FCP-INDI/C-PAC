# Copyright (C) 2022  C-PAC Developers
#
# This file is part of C-PAC.
#
# C-PAC is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
#
# C-PAC is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along with C-PAC. If not, see <https://www.gnu.org/licenses/>.
name: Deploy to Docker Hub

on:
  workflow_call:
    inputs:
      variant:
        required: true
        type: string
    secrets:
      DOCKERHUB_USER:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  Deploy_to_Docker_Hub:
    name: Deploy to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Pull, tag and push
        run: |
          if [[ "${{ inputs.variant }}" != "" ]]
          then
            VARIANT=-${{ inputs.variant }}
          fi
          if [[ "${{ github.ref_type == 'tag' }}" ]]
          then
            TAG1=latest$VARIANT
          else
            TAG1=nightly$VARIANT
          fi
          TAG2=release-${{ github.ref_name }}$VARIANT
          DOCKER_TAG=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "original tag: ${DOCKER_TAG}:${TAG1}"
          echo "new tags: fcpindi/c-pac:${TAG1} fcpindi/c-pac:${TAG2}"
          docker pull ${DOCKER_TAG}:${TAG1}
          docker tag ${DOCKER_TAG}:${TAG1} fcpindi/c-pac:${TAG1}
          docker tag ${DOCKER_TAG}:${TAG1} fcpindi/c-pac:${TAG2}
          docker push fcpindi/c-pac:${TAG1}
          docker push fcpindi/c-pac:${TAG2}
