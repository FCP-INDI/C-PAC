name: Delete development images

on:
  delete:

jobs:
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v4
        with:
          concurrent_skipping: same_content_newer

  C-PAC:
    name: Delete branch images
    runs-on: ubuntu-latest
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true' && github.event.ref_type == 'branch'
    strategy:
      matrix:
        variant:
          - ''
          - lite
          - ABCD-HCP
          - fMRIPrep-LTS
    env:
      GITHUB_TOKEN: ${{ secrets.API_PACKAGE_READ_DELETE }}
      IMAGE: c-pac
    steps:
      - name: Check out C-PAC
        uses: actions/checkout@v2
      - name: 'Delete branch image'
        run: |
          OWNER=$(echo ${GITHUB_REPOSITORY} | cut -d '/' -f 1)
          if [[ $(curl -u ${GITHUB_TOKEN}: https://api.github.com/users/${OWNER} | jq '.type') == '"User"' ]]
          then
            OWNER_TYPE=users
          else
            OWNER_TYPE=org
          fi
          if [[ "${{ inputs.variant }}" != "" ]]
          then
            VARIANT=-${{ inputs.variant }}
          fi
          TAG=${GITHUB_REF_NAME}
          TAG=$TAG$VARIANT
          
          VERSION_ID=$(python .github/scripts/get_package_id.py $OWNER $IMAGE $TAG)
          curl \
            -u ${GITHUB_TOKEN}: \
            -X DELETE \
            https://api.github.com/${OWNER_TYPE}/${OWNER}/packages/container/c-pac/versions/${VERSION_ID}
