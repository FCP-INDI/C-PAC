name: Run Regression Test

on: 
  pull_request:
    types: [ready_for_review]
  workflow_call:

jobs: 
  test:
    runs-on: ubuntu-latest
    steps: 
      - name: Get C-PAC branch
        run: |
          if [[ "${{ matrix.variant }}" != "" ]]
          then
            VARIANT=-${{ matrix.variant }}
          fi
          GITHUB_BRANCH=$(echo ${GITHUB_REF} | cut -d '/' -f 3-)
          if [[ ! $GITHUB_BRANCH == 'main' ]] && [[ ! $GITHUB_BRANCH == 'develop' ]]
          then
            TAG=${GITHUB_BRANCH//\//_}
          elif [[ $GITHUB_BRANCH == 'develop' ]]
          then
            TAG=nightly
          elif [[ $GITHUB_BRANCH == 'main' ]]
          then
            TAG=latest
          fi
          TAG=$TAG$VARIANT
          echo DOCKER_TAG=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]'):$TAG >> $GITHUB_ENV
          cat $GITHUB_ENV

      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Clone reg-suite
        run: |
          git clone https://github.com/amygutierrez/reg-suite.git

      - name: Run Regression Test
        run: |
          #if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.state }}" = "open" ]; then
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Running `lite` regression test"
            python3 reg-suite/main.py run --lite ${{ enc.DOCKER_TAG }}
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.state }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ] && [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            echo "Running `full` regression test"
            python3 reg-suite/main.py run --full ${{ enc.DOCKER_TAG }}
          else
            echo "Skipping regression tests"
          fi